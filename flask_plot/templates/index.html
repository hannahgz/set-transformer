{% import 'macros.html' as macros %}

<!DOCTYPE html>
<html>
<head>
    <title>Card Selector and Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }
        .attribute-select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
        }
        .save-button {
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .duplicate-button {
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-button:hover {
            background-color: #45a049;
        }
        .visualization {
            margin-top: 40px;
            overflow-x: auto;
        }
        .mappings-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        .mapping-item {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .prediction-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .correct {
            color: #28a745;
        }
        .incorrect {
            color: #dc3545;
        }
        .sequence-comparison {
            font-family: 'Courier New', monospace;
            white-space: pre;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .sequence-label {
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }
        .group-header {
            text-align: left;
            margin-bottom: 20px; /* Space between header and cards */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Card Attribute Selector</h2>

        {{ macros.render_group('group1', card_labels) }}
        {{ macros.render_group('group2', card_labels) }}
        
        <button class="save-button" onclick="saveCards()">Save Cards</button>
        <button class="duplicate-button" onclick="duplicateGroup1To2()">Duplicate Group 1 to 2</button>
        <div id="loading-indicator" style="display: none;">
            <div class="spinner"></div>
        </div>

        <label for="threshold-input">Threshold for Weights:</label>
        <input type="number" id="threshold-input" value="0.1" min="0" max="1" step="0.01">


        <div class="mappings-container">
            <h3>Saved Card Mappings</h3>
            <!-- Section for Set 1 -->
            <div class="set-mappings" id="group1-mappings">
                <h4>Set 1</h4>
                <div id="group1-list">
                    {% for mapping in saved_mappings.group1 %}
                    <div class="mapping-item">
                        <strong>Card {{mapping.letter}}:</strong> 
                        {{mapping.attributes.shape}} {{mapping.attributes.color}} {{mapping.attributes.number}} {{mapping.attributes.shading}}
                    </div>
                    {% endfor %}
                </div>
                <div class="prediction-info" id="group1-prediction">
                    <!-- Prediction info will be inserted here -->
                </div>
            </div>

            <!-- Section for Set 2 -->
            <div class="set-mappings" id="group2-mappings">
                <h4>Set 2</h4>
                <div id="group2-list">
                    {% for mapping in saved_mappings.group2 %}
                    <div class="mapping-item">
                        <strong>Card {{mapping.letter}}:</strong> 
                        {{mapping.attributes.shape}} {{mapping.attributes.color}} {{mapping.attributes.number}} {{mapping.attributes.shading}}
                    </div>
                    {% endfor %}
                </div>
                <div class="prediction-info" id="group2-prediction">
                    <!-- Prediction info will be inserted here -->
                </div>
            </div>
        </div>

        <div class="visualization">
            <h2>Attention Visualization</h2>
            <div id="plotly-div"></div>
        </div>
    </div>

    <script>
        // Initialize the plot
        var graphs = {{ plot_json | safe }};
        Plotly.newPlot('plotly-div', graphs.data, graphs.layout);

        function updatePredictionInfo(data) {
            const group1Prediction = document.getElementById('group1-prediction');
            
            // Create a formattedComparison that aligns the sequences
            const formattedComparison = `
                <h3>Prediction Results:</h3>
                <p><strong>Status:</strong> <span class="${data.is_correct1 ? 'correct' : 'incorrect'}">${data.is_correct1 ? 'Correct' : 'Incorrect'}</span></p>
                <div class="sequence-comparison">
                    <div><span class="sequence-label">Input:</span>${data.input1.join(' ')}</div>
                    <div><span class="sequence-label">Prediction: </span>${data.decoded_predictions1}</div>
                    <div><span class="sequence-label">Target: </span>${data.decoded_targets1}</div>
                </div>`;
            
            group1Prediction.innerHTML = formattedComparison;
        }
        
        function saveCards() {
            let group1Cards = [];
            let group2Cards = [];

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';

            // Process Set 1
            for (let i = 0; i < 5; i++) {
                const cardGroup1 = {
                    shape: document.getElementById(`group1-shape${i}`).value,
                    color: document.getElementById(`group1-color${i}`).value,
                    number: document.getElementById(`group1-number${i}`).value,
                    shading: document.getElementById(`group1-shading${i}`).value
                };
                group1Cards.push(cardGroup1);
            }

            // Process Set 2
            for (let i = 0; i < 5; i++) {
                const cardGroup2 = {
                    shape: document.getElementById(`group2-shape${i}`).value,
                    color: document.getElementById(`group2-color${i}`).value,
                    number: document.getElementById(`group2-number${i}`).value,
                    shading: document.getElementById(`group2-shading${i}`).value
                };
                group2Cards.push(cardGroup2);
            }

            // Get the threshold value from the input box
            const threshold = parseFloat(document.getElementById('threshold-input').value);

            // Ensure the threshold value is within [0, 1]
            if (threshold < 0 || threshold > 1 || isNaN(threshold)) {
                alert('Please enter a valid threshold between 0 and 1.');
                return;
            }

            // Combine into an object to send to the server
            const cardData = {
                group1: group1Cards,
                group2: group2Cards
            };

            // Send the data to the server
            fetch('/save_cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cardData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                console.log("Input1: ", data.input1);
                console.log("Input2: ", data.input2);
                // Refresh the page to show updated mappings
                // location.reload();
                // console.log('Server Response:', data);
                // Update prediction information
                updatePredictionInfo(data);

                updateSavedMappings(data.cards);
                const updatedPlot = JSON.parse(data.plot_json);

                console.log('Updated Plot:', updatedPlot);
                // Re-render the plot with the updated data
                Plotly.react('plotly-div', updatedPlot.data, updatedPlot.layout);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error saving cards!');
            }).finally(() => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            });
        }

        function duplicateGroup1To2() {
            for (let i = 0; i < 5; i++) {
                // Get selected values from Set 1
                const shape = document.getElementById(`group1-shape${i}`).value;
                const color = document.getElementById(`group1-color${i}`).value;
                const number = document.getElementById(`group1-number${i}`).value;
                const shading = document.getElementById(`group1-shading${i}`).value;

                // Set those values in Set 2
                document.getElementById(`group2-shape${i}`).value = shape;
                document.getElementById(`group2-color${i}`).value = color;
                document.getElementById(`group2-number${i}`).value = number;
                document.getElementById(`group2-shading${i}`).value = shading;
            }
            // alert('Set 1 values have been duplicated to Set 2!');
        }

        function updateSavedMappings(savedMappings) {
            // Clear the existing mappings
            const group1List = document.getElementById('group1-list');
            const group2List = document.getElementById('group2-list');

            group1List.innerHTML = '';
            group2List.innerHTML = '';

            // Update Set 1 mappings
            savedMappings.group1.forEach((mapping) => {
                const mappingItem = document.createElement('div');
                mappingItem.className = 'mapping-item';
                mappingItem.innerHTML = `
                    <strong>Card ${mapping.letter}:</strong>
                    ${mapping.attributes.shape} ${mapping.attributes.color} ${mapping.attributes.number} ${mapping.attributes.shading}
                `;
                group1List.appendChild(mappingItem);
            });

            // Update Set 2 mappings
            savedMappings.group2.forEach((mapping) => {
                const mappingItem = document.createElement('div');
                mappingItem.className = 'mapping-item';
                mappingItem.innerHTML = `
                    <strong>Card ${mapping.letter}:</strong>
                    ${mapping.attributes.shape} ${mapping.attributes.color} ${mapping.attributes.number} ${mapping.attributes.shading}
                `;
                group2List.appendChild(mappingItem);
            });
        }

    </script>
</body>
</html>